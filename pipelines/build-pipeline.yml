trigger:
- main

pool:
  vmImage: 'windows-latest'

steps:
# Étape 1 : Installer le SDK .NET
- task: UseDotNet@2
  displayName: 'Installer .NET SDK'
  inputs:
    packageType: 'sdk'
    version: '6.x'

# Étape 2 : Restaurer les dépendances
- script: |
    dotnet restore
  workingDirectory: './azure-functions'
  displayName: 'Restaurer les dépendances'

# Étape 3 : Compiler le projet
- script: |
    dotnet build -c Release
  workingDirectory: './azure-functions'
  displayName: 'Compiler le projet'

# Étape 4 : Publier le projet
- script: |
    dotnet publish -c Release -o ./publish
  workingDirectory: './azure-functions'
  displayName: 'Publier le projet'

# Étape 5 : Archiver le package
- task: ArchiveFiles@2
  displayName: 'Archiver les fichiers publiés'
  inputs:
    rootFolderOrFile: './azure-functions/publish'
    archiveFile: '$(Build.ArtifactStagingDirectory)\\azure-functions.zip'
    archiveType: 'zip'

# Étape 6 : Publier l’artefact de build
- task: PublishBuildArtifacts@1
  displayName: 'Publier l’artefact'
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)'
    artifactName: 'FunctionApp'

# Étape 7 : Récupérer dynamiquement la clé de connexion Service Bus
- task: AzureCLI@2
  displayName: 'Récupérer la clé de connexion Service Bus'
  inputs:
    azureSubscription: '<Nom de votre connexion de service Azure>'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      CONNECTION_STRING=$(az servicebus namespace authorization-rule keys list \
        --resource-group '<Nom du groupe de ressources>' \
        --namespace-name '<Nom du namespace Service Bus>' \
        --name 'RootManageSharedAccessKey' \
        --query 'primaryConnectionString' -o tsv)
      echo "##vso[task.setvariable variable=ServiceBusConnectionString]$CONNECTION_STRING"

# Étape 8 : Transmettre la clé aux étapes suivantes
# Si vous avez un déploiement Function App qui suit, cette variable sera accessible
- script: |
    echo "Clé Service Bus récupérée : $(ServiceBusConnectionString)"
  displayName: 'Afficher la clé récupérée (pour vérification)'
